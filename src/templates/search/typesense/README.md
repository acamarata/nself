# Typesense Search Configuration

This directory contains Typesense-specific configuration files and templates for the nself search service.

## What is Typesense?

Typesense is a fast, typo-tolerant search engine optimized for instant search experiences. It's an open-source alternative to Algolia and an excellent alternative to Elasticsearch for most use cases.

## Features

- **Blazing Fast**: Sub-50ms search latency
- **Typo Tolerance**: Automatically handles typos in search queries
- **Faceted Search**: Filter and refine search results
- **Geo Search**: Search by location and distance
- **Vector Search**: Semantic search with embeddings
- **Multi-Tenancy**: Built-in support for isolated data sets

## Configuration

Typesense is configured via environment variables in your `.env` file:

```bash
# Enable search with Typesense
SEARCH_ENABLED=true
SEARCH_PROVIDER=typesense

# Typesense-specific settings
TYPESENSE_VERSION=27.1
TYPESENSE_PORT=8108
TYPESENSE_API_KEY=<auto-generated>
TYPESENSE_ENABLE_CORS=true
TYPESENSE_LOG_LEVEL=info
```

## Quick Start

1. Enable Typesense in your `.env`:
   ```bash
   SEARCH_ENABLED=true
   SEARCH_PROVIDER=typesense
   ```

2. Rebuild your configuration:
   ```bash
   nself build
   ```

3. Start the service:
   ```bash
   nself start
   ```

4. Test the connection:
   ```bash
   nself search test
   ```

## Usage Examples

### JavaScript/TypeScript

```javascript
import Typesense from 'typesense'

const client = new Typesense.Client({
  nodes: [{
    host: 'localhost',
    port: '8108',
    protocol: 'http'
  }],
  apiKey: process.env.SEARCH_API_KEY,
  connectionTimeoutSeconds: 2
})

// Create a collection
const schema = {
  name: 'products',
  fields: [
    { name: 'name', type: 'string' },
    { name: 'description', type: 'string' },
    { name: 'price', type: 'float' },
    { name: 'category', type: 'string', facet: true },
    { name: 'created_at', type: 'int64' }
  ],
  default_sorting_field: 'created_at'
}

await client.collections().create(schema)

// Index documents
await client.collections('products').documents().create({
  name: 'MacBook Pro',
  description: 'Powerful laptop for developers',
  price: 1299.99,
  category: 'Laptops',
  created_at: Date.now()
})

// Search
const searchParameters = {
  q: 'laptop',
  query_by: 'name,description',
  filter_by: 'price:<2000',
  sort_by: 'created_at:desc'
}

const results = await client.collections('products')
  .documents()
  .search(searchParameters)
```

### Python

```python
import typesense
import os

client = typesense.Client({
    'nodes': [{
        'host': 'localhost',
        'port': '8108',
        'protocol': 'http'
    }],
    'api_key': os.environ['SEARCH_API_KEY'],
    'connection_timeout_seconds': 2
})

# Create collection
schema = {
    'name': 'products',
    'fields': [
        {'name': 'name', 'type': 'string'},
        {'name': 'description', 'type': 'string'},
        {'name': 'price', 'type': 'float'},
        {'name': 'category', 'type': 'string', 'facet': True}
    ]
}

client.collections.create(schema)

# Index document
document = {
    'name': 'MacBook Pro',
    'description': 'Powerful laptop',
    'price': 1299.99,
    'category': 'Laptops'
}

client.collections['products'].documents.create(document)

# Search
search_parameters = {
    'q': 'laptop',
    'query_by': 'name,description',
    'filter_by': 'price:<2000'
}

results = client.collections['products'].documents.search(search_parameters)
```

## API Reference

### Health Check
```bash
curl -H "X-TYPESENSE-API-KEY: ${SEARCH_API_KEY}" \
  http://localhost:8108/health
```

### Create Collection
```bash
curl -X POST \
  -H "X-TYPESENSE-API-KEY: ${SEARCH_API_KEY}" \
  -H "Content-Type: application/json" \
  http://localhost:8108/collections \
  -d '{
    "name": "products",
    "fields": [
      {"name": "name", "type": "string"},
      {"name": "price", "type": "float"}
    ]
  }'
```

### Index Document
```bash
curl -X POST \
  -H "X-TYPESENSE-API-KEY: ${SEARCH_API_KEY}" \
  -H "Content-Type: application/json" \
  http://localhost:8108/collections/products/documents \
  -d '{
    "name": "MacBook Pro",
    "price": 1299.99
  }'
```

### Search
```bash
curl -H "X-TYPESENSE-API-KEY: ${SEARCH_API_KEY}" \
  "http://localhost:8108/collections/products/documents/search?q=laptop&query_by=name"
```

## Performance Tips

1. **Use specific query_by fields**: Only search fields you need
2. **Enable caching**: Typesense has built-in caching
3. **Use prefix search**: For autocomplete, enable `prefix=true`
4. **Batch imports**: Use import endpoint for bulk data
5. **Filter before search**: Use `filter_by` to narrow results

## Resources

- [Typesense Documentation](https://typesense.org/docs/)
- [Typesense API Reference](https://typesense.org/docs/latest/api/)
- [Typesense GitHub](https://github.com/typesense/typesense)
- [Client Libraries](https://typesense.org/docs/latest/api/api-clients.html)
