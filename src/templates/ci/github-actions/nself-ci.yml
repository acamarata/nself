# nself CI/CD Pipeline for GitHub Actions
# Generated by: nself ci init
#
# This workflow provides:
# - Build and test on push/PR
# - Deploy to staging on merge to main
# - Deploy to production on release tags
#
# Prerequisites:
# 1. Set up GitHub Secrets:
#    - STAGING_HOST: Staging server hostname
#    - STAGING_USER: SSH username for staging
#    - STAGING_SSH_KEY: SSH private key for staging
#    - PROD_HOST: Production server hostname
#    - PROD_USER: SSH username for production
#    - PROD_SSH_KEY: SSH private key for production
#
# 2. Configure remote servers with nself installed
#
# Usage:
#   Copy this file to .github/workflows/nself-ci.yml

name: nself CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  release:
    types: [published]

env:
  # Project configuration
  PROJECT_NAME: {{PROJECT_NAME}}
  NODE_VERSION: '20'

jobs:
  # ===========================================================================
  # BUILD & TEST
  # ===========================================================================
  build:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint || true

      - name: Run type check
        run: npm run typecheck || true

      - name: Run unit tests
        run: npm test -- --coverage --passWithNoTests

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        if: always()
        with:
          fail_ci_if_error: false

  # ===========================================================================
  # DOCKER BUILD TEST
  # ===========================================================================
  docker-test:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create test environment
        run: |
          cp .env.example .env 2>/dev/null || cat > .env << 'EOF'
          PROJECT_NAME=${{ env.PROJECT_NAME }}
          ENV=test
          BASE_DOMAIN=localhost
          POSTGRES_DB=nhost
          POSTGRES_USER=postgres
          POSTGRES_PASSWORD=test-password
          HASURA_GRAPHQL_ADMIN_SECRET=test-secret
          EOF

      - name: Install nself CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/acamarata/nself/main/install.sh | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Build project
        run: nself build

      - name: Validate docker-compose.yml
        run: docker compose config

      - name: Start services
        run: |
          docker compose up -d
          sleep 30

      - name: Health check
        run: |
          # Check PostgreSQL
          docker compose exec -T postgres pg_isready -U postgres || exit 1

          # Check Hasura
          curl -f http://localhost:8080/healthz || exit 1

      - name: Run integration tests
        run: npm run test:integration || true

      - name: Stop services
        if: always()
        run: docker compose down -v

  # ===========================================================================
  # DEPLOY TO STAGING
  # ===========================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build, docker-test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: staging
      url: https://staging.${{ env.PROJECT_NAME }}.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.STAGING_SSH_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to staging
        run: |
          ssh ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} << 'ENDSSH'
            cd /var/www/${{ env.PROJECT_NAME }}

            # Pull latest code
            git pull origin main

            # Update nself CLI if needed
            nself update || true

            # Rebuild and restart
            nself build
            nself restart

            # Health check
            nself doctor || true

            # Show status
            nself status
          ENDSSH

      - name: Verify deployment
        run: |
          sleep 10
          curl -f https://staging.${{ env.PROJECT_NAME }}.com/health || exit 1

      - name: Notify success
        if: success()
        run: echo "Staging deployment successful"

      - name: Notify failure
        if: failure()
        run: echo "Staging deployment failed"

  # ===========================================================================
  # DEPLOY TO PRODUCTION
  # ===========================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, docker-test]
    if: github.event_name == 'release' && github.event.action == 'published'
    environment:
      name: production
      url: https://${{ env.PROJECT_NAME }}.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.PROD_SSH_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.PROD_HOST }} >> ~/.ssh/known_hosts

      - name: Create database backup
        run: |
          ssh ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} << 'ENDSSH'
            cd /var/www/${{ env.PROJECT_NAME }}
            nself db backup create pre-deploy-${{ github.event.release.tag_name }}
          ENDSSH

      - name: Deploy to production
        run: |
          ssh ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} << 'ENDSSH'
            cd /var/www/${{ env.PROJECT_NAME }}

            # Pull release tag
            git fetch --tags
            git checkout ${{ github.event.release.tag_name }}

            # Update CLI if needed
            nself update || true

            # Rebuild
            nself build

            # Zero-downtime restart
            nself restart --zero-downtime || nself restart

            # Run migrations
            nself db migrate up || true

            # Health check
            nself doctor || true

            # Show status
            nself status
          ENDSSH

      - name: Verify deployment
        run: |
          sleep 15
          curl -f https://${{ env.PROJECT_NAME }}.com/health || exit 1

      - name: Rollback on failure
        if: failure()
        run: |
          ssh ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} << 'ENDSSH'
            cd /var/www/${{ env.PROJECT_NAME }}

            echo "Deployment failed, attempting rollback..."

            # Restore from backup
            nself db restore pre-deploy-${{ github.event.release.tag_name }} || true

            # Checkout previous working version
            git checkout HEAD~1

            # Rebuild and restart
            nself build
            nself restart

            echo "Rollback complete"
          ENDSSH

      - name: Notify success
        if: success()
        run: echo "Production deployment successful"

  # ===========================================================================
  # DATABASE BACKUP (Scheduled)
  # ===========================================================================
  scheduled-backup:
    name: Scheduled Database Backup
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.PROD_SSH_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.PROD_HOST }} >> ~/.ssh/known_hosts

      - name: Create production backup
        run: |
          ssh ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} << 'ENDSSH'
            cd /var/www/${{ env.PROJECT_NAME }}

            # Create compressed backup
            nself db backup create scheduled-$(date +%Y%m%d) --compress

            # Prune old backups (keep last 30)
            nself db backup prune 30
          ENDSSH
