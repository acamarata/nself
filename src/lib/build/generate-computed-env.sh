#!/usr/bin/env bash
# generate-computed-env.sh - Generate computed environment variables
# This creates .env.computed with all derived variables that docker-compose.yml references

generate_computed_env() {
  local output_file="${1:-.env.computed}"

  # Read current environment to get base values
  local project_name="${PROJECT_NAME:-myproject}"
  local env="${ENV:-dev}"
  local base_domain="${BASE_DOMAIN:-localhost}"

  # Compute derived variables
  local docker_network="${project_name}_network"
  local postgres_user="${POSTGRES_USER:-postgres}"
  local postgres_password="${POSTGRES_PASSWORD:-}"
  local postgres_db="${POSTGRES_DB:-${project_name}}"
  local hasura_admin_secret="${HASURA_GRAPHQL_ADMIN_SECRET:-}"
  local hasura_jwt_secret="${HASURA_JWT_SECRET:-}"

  # Construct DATABASE_URL
  local database_url="postgresql://${postgres_user}:${postgres_password}@postgres:5432/${postgres_db}"

  # Construct HASURA_GRAPHQL_JWT_SECRET (if needed)
  local hasura_jwt_config=""
  if [[ -n "$hasura_jwt_secret" ]]; then
    hasura_jwt_config="{\"type\":\"HS256\",\"key\":\"${hasura_jwt_secret}\"}"
  fi

  # Construct HASURA_GRAPHQL_CORS_DOMAIN
  local cors_domain="https://*.${base_domain}, http://*.${base_domain}, http://localhost:*"
  if [[ "$env" == "dev" || "$env" == "development" ]]; then
    cors_domain="${cors_domain}, http://localhost:3000, http://localhost:3001, http://localhost:8080"
  fi

  # Write computed variables to file
  cat > "$output_file" <<EOF
# Generated by nself build - DO NOT EDIT
# Computed environment variables for docker-compose.yml
# These are derived from your base configuration in .env

# Docker Network
DOCKER_NETWORK=${docker_network}

# Database URLs
DATABASE_URL=${database_url}
POSTGRES_URL=${database_url}
AUTH_DATABASE_URL=${database_url}
STORAGE_DATABASE_URL=${database_url}

# Hasura Configuration
EOF

  # Add JWT config if available
  if [[ -n "$hasura_jwt_config" ]]; then
    printf "HASURA_GRAPHQL_JWT_SECRET=%s\n" "$hasura_jwt_config" >> "$output_file"
  fi

  # Add CORS domain
  printf "HASURA_GRAPHQL_CORS_DOMAIN=%s\n" "$cors_domain" >> "$output_file"

  # Add footer
  cat >> "$output_file" <<EOF

# Usage: These variables are automatically loaded by nself CLI commands
# For direct docker-compose usage, load with:
#   docker-compose --env-file .env --env-file .env.computed up
EOF

  # CRITICAL: Merge .env.secrets into .env.computed for docker compose
  # Docker compose needs all variables (base + secrets + computed) in one place
  # This ensures containers receive all required credentials
  if [[ -f ".env.secrets" ]]; then
    printf "\n# Secrets from .env.secrets (auto-merged)\n" >> "$output_file"
    cat ".env.secrets" >> "$output_file"
  fi
}

# Export function for use in other scripts
export -f generate_computed_env
