#!/usr/bin/env bash

# Example pre-commit hook for nself projects
# This hook prevents committing sensitive files to git
#
# To install this hook in your project:
#   cp .github/hooks/pre-commit.example .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Or use nself to install it:
#   nself config hooks install

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Sensitive files that should NEVER be committed (regex patterns)
SENSITIVE_FILES=(
  "\.env\.secrets$"
  "\.env\.local$"
  "ssl/.*\.key$"
  "\.pem$"
  "\.key$"
  "_rsa"
  "id_rsa"
  "\.p12$"
  "\.pfx$"
)

# Check if any sensitive files are being committed
printf "${YELLOW}Checking for sensitive files...${NC}\n"

blocked_files=()

# Get all staged files
staged_files=$(git diff --cached --name-only --diff-filter=ACM)

# Check each staged file against patterns
while IFS= read -r file; do
  if [[ -z "$file" ]]; then
    continue
  fi

  # Check against each pattern
  for pattern in "${SENSITIVE_FILES[@]}"; do
    if echo "$file" | grep -qE "$pattern"; then
      blocked_files+=("$file")
      break
    fi
  done
done <<< "$staged_files"

# If any blocked files found, prevent commit
if [[ ${#blocked_files[@]} -gt 0 ]]; then
  printf "\n${RED}ERROR: Attempted to commit sensitive files!${NC}\n\n"
  printf "The following files should NOT be committed:\n\n"

  for file in "${blocked_files[@]}"; do
    printf "  ${RED}✗${NC} %s\n" "$file"
  done

  printf "\n${YELLOW}To fix this:${NC}\n"
  printf "  1. Unstage the file(s):  ${GREEN}git reset HEAD <file>${NC}\n"
  printf "  2. Add to .gitignore:    ${GREEN}echo '<file>' >> .gitignore${NC}\n"
  printf "  3. If already committed: ${GREEN}git rm --cached <file>${NC}\n"
  printf "\n"
  printf "${YELLOW}To bypass this check (NOT RECOMMENDED):${NC}\n"
  printf "  git commit --no-verify\n"
  printf "\n"

  exit 1
fi

printf "${GREEN}✓ No sensitive files detected${NC}\n"

# Additional checks for .env.secrets security
if [[ -f ".env.secrets" ]]; then
  printf "${YELLOW}Checking .env.secrets security...${NC}\n"

  # Check permissions
  if command -v stat >/dev/null 2>&1; then
    if stat --version 2>/dev/null | grep -q GNU; then
      perms=$(stat -c "%a" ".env.secrets" 2>/dev/null)
    else
      # macOS/BSD
      perms=$(stat -f "%OLp" ".env.secrets" 2>/dev/null)
    fi

    if [[ "$perms" != "600" ]]; then
      printf "${YELLOW}⚠ Warning: .env.secrets has permissions $perms (should be 600)${NC}\n"
      printf "  Fix with: chmod 600 .env.secrets\n"
    else
      printf "${GREEN}✓ .env.secrets has secure permissions (600)${NC}\n"
    fi
  fi

  # Check if in .gitignore
  if [[ -f ".gitignore" ]]; then
    if ! grep -q "\.env\.secrets" .gitignore 2>/dev/null; then
      printf "${YELLOW}⚠ Warning: .env.secrets not found in .gitignore${NC}\n"
      printf "  Fix with: echo '.env.secrets' >> .gitignore\n"
    else
      printf "${GREEN}✓ .env.secrets is in .gitignore${NC}\n"
    fi
  fi
fi

printf "\n${GREEN}✓ Pre-commit checks passed${NC}\n"
exit 0
