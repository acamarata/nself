name: Tenant Isolation Tests

on:
  push:
    paths:
      - 'src/database/migrations/008_*.sql'
      - 'src/database/migrations/009_*.sql'
      - 'src/lib/database/**'
      - 'src/lib/tenant/**'
      - 'src/tests/integration/test-tenant-isolation.sh'
  pull_request:
    paths:
      - 'src/database/migrations/008_*.sql'
      - 'src/database/migrations/009_*.sql'
      - 'src/lib/database/**'
      - 'src/lib/tenant/**'
      - 'src/tests/integration/test-tenant-isolation.sh'
  workflow_dispatch:

jobs:
  tenant-tests:
    name: Multi-Tenancy Integration Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Install nself
        run: |
          # Install nself system-wide (creates symlink at /usr/local/bin/nself)
          sudo ./install.sh system
          # Verify installation
          which nself
          # Note: We can't run 'nself version' here because we're in the source repo
          # The version check will work once we're in the test project directory

      - name: Create test project directory
        run: |
          mkdir -p ~/nself-test
          cd ~/nself-test

      - name: Initialize nself
        run: |
          cd ~/nself-test
          # Run init first (creates default .env)
          nself init --quiet || true
          # Update .env with test configuration
          sed -i 's/^PROJECT_NAME=.*/PROJECT_NAME=nself-test/' .env
          sed -i 's/^ENV=.*/ENV=test/' .env
          # Don't change POSTGRES_DB - let it match PROJECT_NAME
          sed -i 's/^POSTGRES_USER=.*/POSTGRES_USER=postgres/' .env
          sed -i 's/^POSTGRES_PASSWORD=.*/POSTGRES_PASSWORD=postgres/' .env
          # Show the final config
          echo "Final .env configuration:"
          cat .env | grep -v PASSWORD
        env:
          NSELF_SKIP_WIZARD: true

      - name: Build nself
        run: |
          cd ~/nself-test
          # Copy migration files to correct location (nself/migrations)
          mkdir -p nself/migrations
          cp -r ${{ github.workspace }}/src/database/migrations/*.sql nself/migrations/
          # Rebuild to generate config with updated .env values
          nself build

      - name: Start services
        run: |
          cd ~/nself-test
          nself start --verbose || {
            echo "Start failed, showing docker-compose.yml:"
            cat docker-compose.yml
            echo "Showing .env file:"
            cat .env | grep -v PASSWORD
            exit 1
          }
          # Wait for services to be healthy
          sleep 10

      - name: Verify database is running
        run: |
          docker ps | grep postgres
          # Wait for database to be ready
          for i in {1..30}; do
            if docker exec nself-test_postgres pg_isready -U postgres; then
              echo "Database is ready"
              break
            fi
            echo "Waiting for database... ($i/30)"
            sleep 2
          done

      - name: Run migrations
        run: |
          cd ~/nself-test
          nself db migrate up
          # Verify tenant schema exists (database name matches PROJECT_NAME)
          docker exec nself-test_postgres psql -U postgres -d nself-test -c "\dn tenants"

      - name: Run tenant isolation tests
        run: |
          cd ${{ github.workspace }}
          chmod +x src/tests/integration/test-tenant-isolation.sh
          cd ~/nself-test
          # Export environment variables for test script
          export PROJECT_NAME=nself-test
          export ENV=test
          export POSTGRES_USER=postgres
          export POSTGRES_PASSWORD=postgres
          export POSTGRES_DB=nself-test
          ${{ github.workspace }}/src/tests/integration/test-tenant-isolation.sh

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Docker Containers ==="
          docker ps -a
          echo ""
          echo "=== PostgreSQL Logs ==="
          cd ~/nself-test && nself logs postgres --tail 100 || true
          echo ""
          echo "=== Database Status ==="
          docker exec nself-test_postgres psql -U postgres -d nself-test -c "
            SELECT schemaname, tablename
            FROM pg_tables
            WHERE schemaname = 'tenants'
            ORDER BY tablename;
          " || true

      - name: Cleanup
        if: always()
        run: |
          cd ~/nself-test && nself stop || true
          docker system prune -f

  security-audit:
    name: RLS Policy Audit
    runs-on: ubuntu-latest
    needs: tenant-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Audit RLS policies
        run: |
          echo "Checking RLS policy definitions in migration..."

          # Count policies in migration
          policy_count=$(grep -c "CREATE POLICY" src/database/migrations/008_create_tenant_system.sql || echo 0)
          echo "Found $policy_count RLS policies in migration"

          # Verify minimum policy count
          if [ "$policy_count" -lt 10 ]; then
            echo "ERROR: Expected at least 10 RLS policies, found $policy_count"
            exit 1
          fi

          echo "✓ RLS policy count looks good"

          # Check for required policies
          required_policies=(
            "tenant_member_select"
            "tenant_owner_update"
            "tenant_create"
            "tenant_owner_delete"
            "tenant_domains_select"
            "tenant_domains_manage"
            "tenant_members_select"
            "tenant_members_manage"
            "tenant_settings_select"
            "tenant_settings_manage"
          )

          for policy in "${required_policies[@]}"; do
            if ! grep -q "CREATE POLICY $policy" src/database/migrations/008_create_tenant_system.sql; then
              echo "ERROR: Required policy missing: $policy"
              exit 1
            fi
            echo "✓ Found policy: $policy"
          done

          echo "✓ All required RLS policies present"

      - name: Check RLS enable statements
        run: |
          echo "Verifying RLS is enabled on all tenant tables..."

          rls_count=$(grep -c "ENABLE ROW LEVEL SECURITY" src/database/migrations/008_create_tenant_system.sql || echo 0)
          echo "Found $rls_count ENABLE ROW LEVEL SECURITY statements"

          if [ "$rls_count" -lt 5 ]; then
            echo "ERROR: Expected at least 5 tables with RLS enabled, found $rls_count"
            exit 1
          fi

          echo "✓ RLS enabled on all tenant tables"

  documentation-check:
    name: Documentation Verification
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Verify test documentation exists
        run: |
          # Check for test files
          if [ ! -f "src/tests/integration/test-tenant-isolation.sh" ]; then
            echo "ERROR: Main test file missing"
            exit 1
          fi

          # Check for documentation
          if [ ! -f "src/tests/integration/README-TENANT-TESTS.md" ]; then
            echo "ERROR: README missing"
            exit 1
          fi

          if [ ! -f "src/tests/integration/TENANT-TESTS-SUMMARY.md" ]; then
            echo "ERROR: Summary missing"
            exit 1
          fi

          if [ ! -f "src/tests/integration/TENANT-TESTS-QUICK-REF.md" ]; then
            echo "ERROR: Quick reference missing"
            exit 1
          fi

          echo "✓ All test documentation files present"

      - name: Verify test file is executable
        run: |
          if [ ! -x "src/tests/integration/test-tenant-isolation.sh" ]; then
            echo "ERROR: Test file is not executable"
            exit 1
          fi
          echo "✓ Test file is executable"

      - name: Check test suite count
        run: |
          suite_count=$(grep -c "^test_" src/tests/integration/test-tenant-isolation.sh || echo 0)
          echo "Found $suite_count test suites"

          if [ "$suite_count" -lt 6 ]; then
            echo "ERROR: Expected at least 6 test suites, found $suite_count"
            exit 1
          fi

          echo "✓ All test suites present"

      - name: Verify assertion functions
        run: |
          assertions=(
            "assert_equals"
            "assert_not_equals"
            "assert_empty"
            "assert_not_empty"
          )

          for assertion in "${assertions[@]}"; do
            if ! grep -q "^${assertion}()" src/tests/integration/test-tenant-isolation.sh; then
              echo "ERROR: Assertion function missing: $assertion"
              exit 1
            fi
            echo "✓ Found assertion: $assertion"
          done

          echo "✓ All assertion functions present"
