name: Branch Coverage Check

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/lib/**/*.sh'
      - 'src/cli/**/*.sh'
      - 'src/tests/**/*.sh'
      - 'scripts/branch-coverage-analysis.sh'
      - 'scripts/show-untested-branches.sh'
      - '.github/workflows/branch-coverage.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/lib/**/*.sh'
      - 'src/cli/**/*.sh'
      - 'src/tests/**/*.sh'
      - 'scripts/branch-coverage-analysis.sh'
      - 'scripts/show-untested-branches.sh'
      - '.github/workflows/branch-coverage.yml'

jobs:
  analyze-branch-coverage:
    name: Analyze Branch Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          chmod +x scripts/branch-coverage-analysis.sh
          chmod +x scripts/show-untested-branches.sh
          mkdir -p .coverage

      - name: Run branch coverage analysis
        id: coverage
        run: |
          bash scripts/branch-coverage-analysis.sh > .coverage/analysis-output.txt 2>&1
          cat .coverage/analysis-output.txt

      - name: Check coverage threshold
        run: |
          # Extract coverage percentage from JSON report
          if [[ -f .coverage/branch-coverage.json ]]; then
            COVERAGE=$(jq -r '.coverage_percent' .coverage/branch-coverage.json)
            echo "Branch Coverage: ${COVERAGE}%"

            # Set minimum threshold (start at 60%, increase gradually)
            THRESHOLD=60

            if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
              echo "‚ùå Branch coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
              echo ""
              echo "Untested branches:"
              bash scripts/show-untested-branches.sh
              exit 1
            else
              echo "‚úÖ Branch coverage ${COVERAGE}% meets threshold ${THRESHOLD}%"
            fi
          else
            echo "‚ö†Ô∏è  Coverage report not found, skipping threshold check"
          fi

      - name: Upload coverage reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: branch-coverage-reports
          path: |
            .coverage/branch-coverage-report.txt
            .coverage/branch-coverage.json
            .coverage/untested-branches.txt
          retention-days: 30

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read coverage report
            let coverageData = {};
            try {
              const coverageJson = fs.readFileSync('.coverage/branch-coverage.json', 'utf8');
              coverageData = JSON.parse(coverageJson);
            } catch (error) {
              console.log('Could not read coverage report');
              return;
            }

            // Create comment body
            const coverage = coverageData.coverage_percent || 0;
            const total = coverageData.total_branches || 0;
            const tested = coverageData.tested_branches || 0;
            const remaining = total - tested;

            const emoji = coverage >= 80 ? '‚úÖ' : coverage >= 60 ? '‚ö†Ô∏è' : '‚ùå';

            const body = `## ${emoji} Branch Coverage Report

            **Coverage:** ${coverage}%
            **Branches:** ${tested} / ${total} tested
            **Remaining:** ${remaining} untested branches

            ### Branch Types
            - If statements: ${coverageData.branch_types?.if_branches || 0}
            - Case statements: ${coverageData.branch_types?.case_branches || 0}
            - Logical operators: ${coverageData.branch_types?.logical_branches || 0}
            - Return statements: ${coverageData.branch_types?.return_statements || 0}

            ${coverage < 100 ? `
            ### Goal
            üéØ Target: 100% branch coverage
            üìä Progress: ${coverage}%
            üöÄ Keep testing to cover all code paths!
            ` : `
            ### üéâ Perfect Score!
            All branches are covered by tests!
            `}

            ---
            *Report generated by branch-coverage-analysis.sh*
            `;

            // Post comment
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  run-branch-coverage-tests:
    name: Run Branch Coverage Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up test environment
        run: |
          chmod +x src/tests/unit/test-branch-coverage-template.sh
          chmod +x src/tests/unit/test-validation-branch-coverage.sh
          chmod +x src/tests/mocks/environment-control.sh

      - name: Run branch coverage template tests
        run: |
          bash src/tests/unit/test-branch-coverage-template.sh

      - name: Run validation branch coverage tests
        run: |
          bash src/tests/unit/test-validation-branch-coverage.sh

      - name: Report test results
        if: always()
        run: |
          echo "Branch coverage tests completed on ${{ matrix.os }}"
