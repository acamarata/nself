# v0.4.7 Planning - Multi-Cloud Providers

**Target**: Q3 2026
**Focus**: Deploy anywhere with one command

**Depends on**: v0.4.3-v0.4.6 (complete deployment and scaling stack)

---

## Overview

Support for all major cloud providers and VPS platforms. One-command provisioning with cost estimation, Terraform export for custom infrastructure.

---

## New Commands

| Command | Purpose |
|---------|---------|
| `nself cloud` | Cloud provider management |
| `nself provision` | Infrastructure provisioning |

---

## Supported Providers

| Provider | Services | Status |
|----------|----------|--------|
| **AWS** | EC2, RDS, S3, ECS, EKS | Full |
| **Google Cloud** | Compute Engine, Cloud SQL, Cloud Storage, GKE | Full |
| **Azure** | Virtual Machines, Azure Database, Blob Storage, AKS | Full |
| **DigitalOcean** | Droplets, Managed Databases, Spaces, DOKS | Full |
| **Linode** | Linodes, Managed Databases, Object Storage, LKE | Full |
| **Vultr** | Cloud Compute, Managed Databases, Object Storage | Full |
| **Hetzner** | Cloud Servers, Volumes, Load Balancers | Full |

---

## Detailed Feature Specifications

### 1. Cloud Provider Management (`nself cloud`)

#### Subcommands
```bash
# Provider setup
nself cloud init <provider>           # Configure provider credentials
nself cloud init aws                  # Setup AWS
nself cloud init gcp                  # Setup Google Cloud
nself cloud init azure                # Setup Azure
nself cloud init do                   # Setup DigitalOcean
nself cloud init linode               # Setup Linode
nself cloud init vultr                # Setup Vultr
nself cloud init hetzner              # Setup Hetzner

# Provider management
nself cloud list                      # List configured providers
nself cloud status                    # Show resource status
nself cloud status aws                # Provider-specific status
nself cloud remove <provider>         # Remove provider config

# Cost management
nself cloud costs                     # Show current costs
nself cloud costs --forecast          # Forecast monthly costs
nself cloud costs --compare           # Compare providers
nself cloud budget                    # Set budget alerts

# Resources
nself cloud resources                 # List all cloud resources
nself cloud resources --provider aws
nself cloud destroy                   # Tear down all resources
nself cloud destroy --provider aws    # Provider-specific
```

#### Provider Configuration

##### AWS Setup
```bash
nself cloud init aws

# Interactive prompts:
# > AWS Access Key ID: AKIA...
# > AWS Secret Access Key: ********
# > Default Region [us-east-1]: us-west-2
# > Default Instance Type [t3.medium]:
#
# Testing connection...
# ✓ AWS credentials valid
# ✓ Permissions verified (EC2, RDS, S3)
#
# Configuration saved to ~/.nself/clouds/aws.json
```

##### DigitalOcean Setup
```bash
nself cloud init do

# > DigitalOcean API Token: ********
# > Default Region [nyc1]: sfo3
# > Default Droplet Size [s-2vcpu-4gb]:
#
# ✓ Connection verified
```

##### Hetzner Setup
```bash
nself cloud init hetzner

# > Hetzner API Token: ********
# > Default Location [fsn1]: nbg1
# > Default Server Type [cx21]:
#
# ✓ Connection verified
```

#### Credentials Storage

```yaml
# ~/.nself/clouds/aws.json
{
  "provider": "aws",
  "credentials": {
    "access_key_id": "AKIA...",
    "secret_access_key": "encrypted:...",
    "region": "us-west-2"
  },
  "defaults": {
    "instance_type": "t3.medium",
    "vpc": "auto",
    "security_group": "auto"
  }
}
```

Options for credential storage:
1. File-based (encrypted at rest)
2. Environment variables
3. System keychain (macOS Keychain, Linux Secret Service)
4. AWS profiles (~/.aws/credentials)
5. Cloud provider CLI configs

---

### 2. Infrastructure Provisioning (`nself provision`)

#### Subcommands
```bash
# Basic provisioning
nself provision <provider>            # Provision on provider
nself provision aws                   # Provision on AWS
nself provision do                    # Provision on DigitalOcean
nself provision hetzner               # Provision on Hetzner

# Options
nself provision aws --size t3.large   # Specify size
nself provision do --region sfo3      # Specify region
nself provision --dry-run             # Preview resources
nself provision --estimate            # Cost estimate only

# Configuration-based
nself provision --config infra.yaml   # Use config file
nself provision --env staging         # Environment-specific

# Export
nself provision export terraform      # Export as Terraform
nself provision export pulumi         # Export as Pulumi
nself provision export cloudformation # Export as CFN (AWS)
```

#### Provisioning Wizard

```bash
nself provision aws

# ┌─────────────────────────────────────────────────────────────┐
# │ nself Infrastructure Provisioning - AWS                     │
# ├─────────────────────────────────────────────────────────────┤
# │                                                             │
# │ Project: myapp                                              │
# │ Environment: production                                     │
# │                                                             │
# │ What would you like to provision?                           │
# │                                                             │
# │ ○ Single Server (all-in-one)                               │
# │ ● Standard (separate DB)                                    │
# │ ○ High Availability (multi-AZ)                             │
# │ ○ Custom                                                    │
# │                                                             │
# └─────────────────────────────────────────────────────────────┘

# ┌─────────────────────────────────────────────────────────────┐
# │ Server Configuration                                        │
# ├─────────────────────────────────────────────────────────────┤
# │                                                             │
# │ Instance Type:  [t3.medium ▼]                              │
# │ Region:         [us-west-2 ▼]                              │
# │ Storage:        [50 GB    ]                                │
# │                                                             │
# │ Database:                                                   │
# │ ○ PostgreSQL on same server                                │
# │ ● RDS PostgreSQL (managed)                                  │
# │                                                             │
# │ RDS Instance:   [db.t3.medium ▼]                           │
# │ Storage:        [100 GB       ]                            │
# │                                                             │
# └─────────────────────────────────────────────────────────────┘

# ┌─────────────────────────────────────────────────────────────┐
# │ Cost Estimate                                               │
# ├─────────────────────────────────────────────────────────────┤
# │                                                             │
# │ EC2 t3.medium:         $30.37/month                        │
# │ RDS db.t3.medium:      $49.06/month                        │
# │ Storage (150 GB):       $15.00/month                       │
# │ Data Transfer:          ~$10.00/month                      │
# │ ─────────────────────────────────────────                  │
# │ Estimated Total:        $104.43/month                      │
# │                                                             │
# │ [Proceed]  [Modify]  [Cancel]                              │
# └─────────────────────────────────────────────────────────────┘
```

#### Infrastructure Configuration File

```yaml
# infra.yaml
version: 1
project: myapp
environment: production

provider:
  name: aws
  region: us-west-2

compute:
  type: t3.medium
  count: 1
  ami: auto  # nself selects appropriate image
  storage:
    root: 50
    data: 100

database:
  type: managed  # or "local"
  provider: rds
  instance: db.t3.medium
  storage: 100
  multi_az: false
  backup_retention: 7

storage:
  type: s3
  bucket: myapp-storage

networking:
  vpc: auto
  subnets: auto
  security_groups:
    - ssh: ["office_ip", "home_ip"]
    - http: ["0.0.0.0/0"]
    - https: ["0.0.0.0/0"]
    - postgres: ["vpc_only"]

dns:
  provider: route53  # or cloudflare, manual
  domain: myapp.com
  subdomains:
    - api
    - admin
    - grafana

ssl:
  provider: letsencrypt
  email: admin@myapp.com
```

#### Provider-Specific Sizing

```bash
# Equivalent sizes across providers
nself provision --size small    # t3.small / s-1vcpu-2gb / cx11
nself provision --size medium   # t3.medium / s-2vcpu-4gb / cx21
nself provision --size large    # t3.large / s-4vcpu-8gb / cx31
nself provision --size xlarge   # t3.xlarge / s-8vcpu-16gb / cx41

# Or provider-specific
nself provision aws --size t3.2xlarge
nself provision do --size s-8vcpu-32gb
nself provision hetzner --size cx51
```

#### Cost Comparison

```bash
nself cloud costs --compare

# ┌─────────────────────────────────────────────────────────────┐
# │ Monthly Cost Comparison (Standard Setup)                    │
# ├─────────────────────────────────────────────────────────────┤
# │                                                             │
# │ Provider       Compute    Database   Storage    Total       │
# │ ─────────────────────────────────────────────────────────  │
# │ Hetzner         $15.90     $29.00     $5.00    $49.90 ★    │
# │ Vultr           $24.00     $60.00     $5.00    $89.00      │
# │ Linode          $24.00     $50.00     $5.00    $79.00      │
# │ DigitalOcean    $24.00     $50.00     $5.00    $79.00      │
# │ AWS             $30.37     $49.06    $15.00   $104.43      │
# │ Google Cloud    $35.00     $51.00    $12.00    $98.00      │
# │ Azure           $36.50     $52.00    $10.00    $98.50      │
# │                                                             │
# │ ★ = Lowest cost for equivalent resources                   │
# └─────────────────────────────────────────────────────────────┘
```

#### Terraform Export

```bash
nself provision export terraform

# Creates:
# terraform/
# ├── main.tf
# ├── variables.tf
# ├── outputs.tf
# ├── provider.tf
# └── terraform.tfvars

# Can be customized and used with standard Terraform workflow
```

---

## Implementation Files

### New CLI Commands
```
src/cli/cloud.sh             # Cloud management
src/cli/provision.sh         # Provisioning
```

### New Library Files
```
src/lib/cloud/
├── init.sh                  # Provider initialization
├── credentials.sh           # Credential management
├── status.sh                # Resource status
├── costs.sh                 # Cost tracking
└── destroy.sh               # Teardown

src/lib/provision/
├── wizard.sh                # Interactive wizard
├── estimate.sh              # Cost estimation
├── config.sh                # Config file handling
└── providers/
    ├── aws.sh               # AWS provisioning
    ├── gcp.sh               # Google Cloud
    ├── azure.sh             # Azure
    ├── digitalocean.sh      # DigitalOcean
    ├── linode.sh            # Linode
    ├── vultr.sh             # Vultr
    └── hetzner.sh           # Hetzner

src/lib/export/
├── terraform.sh             # Terraform export
├── pulumi.sh                # Pulumi export
└── cloudformation.sh        # CloudFormation export
```

### Templates
```
src/templates/infrastructure/
├── aws/
│   ├── single-server.yaml
│   ├── standard.yaml
│   └── high-availability.yaml
├── digitalocean/
│   └── ...
└── terraform/
    ├── aws/
    ├── gcp/
    └── ...
```

---

## Environment Variable Additions

```bash
# Cloud credentials (per provider)
AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
AWS_DEFAULT_REGION=us-east-1

DO_API_TOKEN=
DO_DEFAULT_REGION=nyc1

LINODE_API_TOKEN=
LINODE_DEFAULT_REGION=us-east

HETZNER_API_TOKEN=
HETZNER_DEFAULT_LOCATION=fsn1

VULTR_API_KEY=
VULTR_DEFAULT_REGION=ewr

# GCP uses service account JSON
GCP_PROJECT_ID=
GCP_CREDENTIALS_FILE=~/.gcp/credentials.json

# Azure
AZURE_SUBSCRIPTION_ID=
AZURE_TENANT_ID=
AZURE_CLIENT_ID=
AZURE_CLIENT_SECRET=

# General
CLOUD_DEFAULT_PROVIDER=aws
CLOUD_COST_ALERT_THRESHOLD=100
```

---

## Dependencies

- Provider CLIs (optional but recommended):
  - `aws` (AWS CLI)
  - `gcloud` (Google Cloud SDK)
  - `az` (Azure CLI)
  - `doctl` (DigitalOcean CLI)
  - `linode-cli`
  - `vultr-cli`
  - `hcloud` (Hetzner CLI)
- `terraform` (optional, for export)
- `jq` for JSON processing

---

## Success Criteria

1. ✓ `nself provision aws` creates working infrastructure
2. ✓ `nself provision do` creates working infrastructure
3. ✓ `nself provision hetzner` creates working infrastructure
4. ✓ Cost estimates are accurate (within 10%)
5. ✓ Terraform export produces valid, working configs
6. ✓ Cross-provider comparison helps with cost decisions
7. ✓ All 7 providers have full parity

---

*Last Updated: January 22, 2026*
