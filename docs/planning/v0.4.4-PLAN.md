# v0.4.4 Planning - Database, Backup & Restore

**Target**: Q1-Q2 2026
**Focus**: Complete database lifecycle management

**Depends on**: v0.4.3 (environments for backup destinations)

---

## Overview

Full database lifecycle management including migrations, backups, restores, and database operations. This release makes database management production-ready.

---

## New Commands

| Command | Purpose |
|---------|---------|
| `nself db` | Database operations & migrations |
| `nself backup` | Create and manage backups |
| `nself restore` | Restore from backups |

---

## Detailed Feature Specifications

### 1. Database Operations (`nself db`)

#### Subcommands
```bash
# Migrations
nself db migrate                 # Run pending migrations
nself db migrate:create <name>   # Create new migration file
nself db migrate:rollback        # Rollback last migration
nself db migrate:rollback --all  # Rollback all migrations
nself db migrate:status          # Show migration status
nself db migrate:fresh           # Drop all tables and re-run migrations

# Operations
nself db shell                   # Interactive psql session
nself db query "<sql>"           # Run SQL query
nself db dump                    # Dump database to file
nself db load <file>             # Load dump into database

# Analysis
nself db status                  # Database health status
nself db size                    # Table sizes and disk usage
nself db optimize                # Analyze and vacuum
nself db slow-queries            # Show slow query log

# Cloning
nself db clone staging           # Clone current DB to staging
nself db clone --from prod       # Clone from production (anonymized)
```

#### Migration System

##### Migration Files Structure
```
migrations/
├── 001_create_users.sql
├── 002_add_email_to_users.sql
├── 003_create_posts.sql
└── ...
```

##### Migration File Format
```sql
-- migrations/001_create_users.sql
-- Up
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email TEXT UNIQUE NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Down
DROP TABLE users;
```

##### Migration Tracking
- Track applied migrations in `_nself_migrations` table
- Support for both raw SQL and Hasura migrations
- Integrate with Hasura CLI if available

#### Database Connection
```bash
# Uses environment's database config
nself db shell
# psql (15.4)
# Type "help" for help.
# myapp_db=#

# Or specify environment
nself db shell --env staging
nself db shell --env prod
```

---

### 2. Backup System (`nself backup`)

#### Subcommands
```bash
# Creation
nself backup create              # Full backup
nself backup create --name weekly-backup
nself backup create --incremental
nself backup create --schema-only
nself backup create --data-only

# Management
nself backup list                # List all backups
nself backup list --remote       # List remote backups (S3)
nself backup info <backup-id>    # Show backup details
nself backup delete <backup-id>  # Delete backup
nself backup verify <backup-id>  # Verify backup integrity

# Scheduling
nself backup schedule            # Configure backup schedule
nself backup schedule --show     # Show current schedule
nself backup schedule --disable  # Disable scheduled backups

# Storage
nself backup storage             # Configure storage backends
nself backup upload <backup-id>  # Upload to remote storage
nself backup download <backup-id> # Download from remote
```

#### Backup Types

1. **Full Backup**
   - Complete database dump
   - All schemas, data, extensions
   - pg_dump with custom format

2. **Incremental Backup**
   - WAL-based incremental backup
   - Requires WAL archiving enabled
   - Space-efficient for frequent backups

3. **Schema-Only Backup**
   - Structure without data
   - Useful for development setup

4. **Data-Only Backup**
   - Data without structure
   - For data migration scenarios

#### Backup Storage Backends

```bash
# Local storage (default)
nself backup storage set local --path ./backups

# S3-compatible storage
nself backup storage set s3 \
  --endpoint s3.amazonaws.com \
  --bucket my-backups \
  --access-key AKIA... \
  --secret-key ...

# MinIO (self-hosted S3)
nself backup storage set s3 \
  --endpoint minio.example.com:9000 \
  --bucket backups \
  --access-key minioadmin \
  --secret-key minioadmin

# Backblaze B2
nself backup storage set b2 \
  --bucket my-backups \
  --key-id ... \
  --application-key ...
```

#### Backup Encryption

```bash
# Enable encryption
nself backup config --encrypt

# Set encryption key (or auto-generate)
nself backup config --encryption-key <key>

# Encryption uses AES-256-GCM
# Key stored in environment or keychain
```

#### Scheduled Backups

```bash
# Interactive schedule setup
nself backup schedule

# Predefined schedules
nself backup schedule --preset daily      # Daily at 2 AM
nself backup schedule --preset weekly     # Weekly Sunday 2 AM
nself backup schedule --preset hourly     # Every hour

# Custom cron schedule
nself backup schedule --cron "0 */6 * * *"  # Every 6 hours

# Shows crontab entry or systemd timer
```

#### Backup Retention

```bash
# Configure retention
nself backup config --retention 30        # Keep 30 days
nself backup config --retention-count 10  # Keep 10 backups
nself backup prune                        # Apply retention policy
```

---

### 3. Restore System (`nself restore`)

#### Subcommands
```bash
# Restore operations
nself restore latest             # Restore most recent backup
nself restore <backup-id>        # Restore specific backup
nself restore --list             # List available backups

# Point-in-time recovery
nself restore --point-in-time "2026-01-15 14:30:00"

# Cross-environment restore
nself restore <backup-id> --to staging
nself restore <backup-id> --to local

# Options
nself restore --dry-run          # Preview restore
nself restore --no-backup        # Skip pre-restore backup
nself restore --schema-only      # Structure only
nself restore --data-only        # Data only
nself restore --table users      # Single table
```

#### Restore Safety Features

1. **Pre-Restore Backup**
   - Automatic backup before restore (unless `--no-backup`)
   - Labeled as `pre-restore-<timestamp>`
   - Easy rollback if restore fails

2. **Confirmation Prompts**
   ```
   ⚠️  You are about to restore to PRODUCTION database

   Backup: weekly-2026-01-15 (2.3 GB)
   Target: prod.example.com:5432/myapp_db

   This will REPLACE all existing data.
   A backup will be created before restore.

   Type 'yes' to continue:
   ```

3. **Environment Protection**
   - Extra confirmation for production
   - Option to require `--force` for prod

4. **Data Anonymization for Cross-Env**
   ```bash
   # When restoring prod to staging/local
   nself restore prod-backup --to staging --anonymize

   # Anonymizes: emails, names, addresses, etc.
   # Configurable via anonymization rules
   ```

#### Point-in-Time Recovery (PITR)

```bash
# Requires WAL archiving enabled
nself db config --enable-wal-archiving

# PITR to specific time
nself restore --point-in-time "2026-01-15 14:30:00"

# PITR to before specific transaction
nself restore --point-in-time "2026-01-15 14:30:00" --exclusive
```

---

## Implementation Files

### New CLI Commands
```
src/cli/db.sh                # Database operations
src/cli/backup.sh            # Backup command
src/cli/restore.sh           # Restore command
```

### New Library Files
```
src/lib/database/
├── migrate.sh               # Migration system
├── shell.sh                 # Interactive shell
├── query.sh                 # Query execution
├── dump.sh                  # Database dumps
├── clone.sh                 # Database cloning
├── analyze.sh               # Performance analysis
└── connection.sh            # Connection management

src/lib/backup/
├── create.sh                # Backup creation
├── storage.sh               # Storage backend management
├── schedule.sh              # Backup scheduling
├── encrypt.sh               # Encryption handling
├── verify.sh                # Integrity verification
└── retention.sh             # Retention policy

src/lib/restore/
├── restore.sh               # Core restore logic
├── pitr.sh                  # Point-in-time recovery
├── anonymize.sh             # Data anonymization
└── validate.sh              # Restore validation
```

### Migration Templates
```
src/templates/migrations/
├── create_table.sql.template
├── add_column.sql.template
├── create_index.sql.template
└── hasura/
    ├── migration.yaml.template
    └── metadata.yaml.template
```

---

## Environment Variable Additions

```bash
# Database
DB_MIGRATION_PATH=./migrations
DB_MIGRATION_TABLE=_nself_migrations

# Backup
BACKUP_STORAGE=local                # local, s3, b2
BACKUP_PATH=./backups               # For local storage
BACKUP_RETENTION_DAYS=30
BACKUP_RETENTION_COUNT=10
BACKUP_ENCRYPTION=true
BACKUP_ENCRYPTION_KEY=              # Auto-generated if empty

# S3/MinIO Backup Storage
BACKUP_S3_ENDPOINT=s3.amazonaws.com
BACKUP_S3_BUCKET=my-backups
BACKUP_S3_ACCESS_KEY=
BACKUP_S3_SECRET_KEY=
BACKUP_S3_REGION=us-east-1

# WAL Archiving (for PITR)
POSTGRES_WAL_LEVEL=replica
POSTGRES_ARCHIVE_MODE=on
POSTGRES_ARCHIVE_COMMAND=
```

---

## Testing Requirements

### Unit Tests
- Migration file parsing
- Backup metadata handling
- Encryption/decryption
- Retention policy calculations

### Integration Tests
- Full backup/restore cycle
- Migration up/down
- S3 storage upload/download
- Cross-environment restore

### Manual Testing
- Large database backup (10GB+)
- PITR recovery
- Production restore to staging

---

## Documentation Required

```
docs/commands/DB.md
docs/commands/BACKUP.md
docs/commands/RESTORE.md
docs/guides/database-migrations.md
docs/guides/backup-strategy.md
docs/guides/disaster-recovery.md
```

---

## Dependencies

- pg_dump / pg_restore (PostgreSQL client tools)
- aws CLI or s3cmd (for S3 storage)
- gpg or openssl (for encryption)
- cron or systemd (for scheduling)

---

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Backup corruption | Automatic verification, checksums |
| Restore overwrites data | Pre-restore backup, confirmations |
| Large backup timeouts | Streaming backup, progress indicator |
| Encryption key loss | Key backup reminders, recovery options |
| PITR gaps | WAL archiving monitoring |

---

## Success Criteria

1. ✓ `nself backup create` completes in reasonable time
2. ✓ `nself restore <id>` restores accurately
3. ✓ Scheduled backups run reliably
4. ✓ S3 storage works with AWS, MinIO, Backblaze
5. ✓ Encryption/decryption works correctly
6. ✓ PITR works to exact timestamp
7. ✓ Cross-environment restore with anonymization works

---

*Last Updated: January 22, 2026*
