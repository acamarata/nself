# v0.4.5 Planning - Mock Data & Seeding System

**Target**: Q2 2026
**Focus**: Automatic data generation and seeding

**Depends on**: v0.4.3 (environments), v0.4.4 (database operations)

---

## Overview

Smart data generation that automatically uses mock data in local/staging and real data in production. Schema-aware mock generation with realistic fake data, plus seeding system for initial users and configuration.

---

## New Commands

| Command | Purpose |
|---------|---------|
| `nself seed` | Seed database with data |
| `nself mock` | Generate mock/fake data |
| `nself data` | Data management utilities |

---

## Core Philosophy

### Environment-Aware Behavior (AUTOMATIC)

| Environment | Mock Data | Seeding | Real Data |
|-------------|-----------|---------|-----------|
| **Local** | ✓ Full mock data | ✓ Test users | ✗ Never |
| **Staging** | ✓ Realistic volumes | ✓ Test users | ✗ Never |
| **Production** | ✗ Never | ✓ Admin users only | ✓ Yes |

**No manual configuration needed** - detected automatically from ENV variable.

---

## Detailed Feature Specifications

### 1. Mock Data Generation (`nself mock`)

#### Subcommands
```bash
# Generation
nself mock generate              # Generate mock data for all tables
nself mock generate users        # Generate for specific table
nself mock generate --count 1000 # Specify row count

# Configuration
nself mock init                  # Create mock configuration file
nself mock config                # Edit mock configuration
nself mock preview               # Preview generated data

# Management
nself mock status                # Show mock data status
nself mock clear                 # Remove all mock data
nself mock refresh               # Clear and regenerate
```

#### Schema-Aware Generation

The mock generator reads the database schema and generates appropriate data:

```sql
-- For this table:
CREATE TABLE users (
  id UUID PRIMARY KEY,
  email TEXT UNIQUE NOT NULL,
  first_name TEXT,
  last_name TEXT,
  phone TEXT,
  address JSONB,
  role TEXT DEFAULT 'user',
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Generates:
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "email": "john.doe@example.com",
  "first_name": "John",
  "last_name": "Doe",
  "phone": "+1-555-123-4567",
  "address": {
    "street": "123 Main St",
    "city": "San Francisco",
    "state": "CA",
    "zip": "94102"
  },
  "role": "user",
  "created_at": "2026-01-15T10:30:00Z"
}
```

#### Smart Type Detection

| Column Pattern | Generated Data |
|----------------|----------------|
| `*email*` | Realistic email addresses |
| `*name*`, `first_name` | First/last names |
| `*phone*` | Phone numbers |
| `*address*` | Full addresses |
| `*url*`, `*link*` | URLs |
| `*image*`, `*avatar*`, `*photo*` | Placeholder image URLs |
| `*price*`, `*amount*`, `*cost*` | Currency values |
| `*date*`, `*_at` | Timestamps |
| `*description*`, `*bio*`, `*text*` | Lorem ipsum paragraphs |
| `*slug*` | URL-safe slugs |
| `*uuid*`, `*id` | UUIDs |
| `*password*` | Hashed passwords |
| `*token*` | Random tokens |
| `BOOLEAN` | Random true/false |
| `INTEGER` | Random integers |
| `JSONB` | Appropriate JSON objects |

#### Foreign Key Handling

```sql
-- Posts references users
CREATE TABLE posts (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  title TEXT,
  content TEXT
);
```

Mock generator:
1. Detects foreign key relationships
2. Generates parent data first (users)
3. References existing parent IDs in children (posts)
4. Maintains referential integrity

#### Mock Configuration File

```yaml
# mock.yaml
version: 1

# Global settings
settings:
  locale: en_US
  seed: 12345  # For reproducible data

# Table-specific configuration
tables:
  users:
    count: 100
    columns:
      email:
        unique: true
        domain: "@testcompany.com"
      role:
        values: ["user", "admin", "moderator"]
        weights: [0.8, 0.1, 0.1]
      created_at:
        range: ["2025-01-01", "2026-01-01"]

  posts:
    count: 500
    columns:
      title:
        type: sentence
        words: [3, 8]  # min, max words
      content:
        type: paragraphs
        count: [2, 5]
      status:
        values: ["draft", "published", "archived"]
        weights: [0.1, 0.8, 0.1]

  # Skip certain tables
  _nself_migrations:
    skip: true

# Relationships
relationships:
  posts.user_id:
    distribution: zipf  # Some users have many posts
```

#### Volume Presets

```bash
nself mock generate --preset minimal   # 10 rows per table
nself mock generate --preset small     # 100 rows per table
nself mock generate --preset medium    # 1,000 rows per table
nself mock generate --preset large     # 10,000 rows per table
nself mock generate --preset realistic # Varies by table type
```

---

### 2. Seeding System (`nself seed`)

#### Subcommands
```bash
# Running seeds
nself seed                       # Run all seed files
nself seed run                   # Same as above
nself seed run users             # Run specific seed
nself seed run --fresh           # Clear and re-seed

# Built-in seeds
nself seed users                 # Seed initial users
nself seed roles                 # Seed roles and permissions
nself seed config                # Seed app configuration

# Management
nself seed init                  # Create seed directory and templates
nself seed create <name>         # Create new seed file
nself seed list                  # List available seeds
nself seed status                # Show which seeds have run
```

#### Seed Files Structure

```
seeds/
├── 001_roles.sql                # Role definitions
├── 002_admin_user.sql           # Admin user
├── 003_app_config.sql           # Application settings
├── 004_categories.sql           # Default categories
└── local/                       # Local-only seeds
    ├── test_users.sql
    └── sample_data.sql
```

#### Seed File Format

```sql
-- seeds/002_admin_user.sql
-- Description: Create initial admin user
-- Environment: all (or: local, staging, prod)
-- Idempotent: true

INSERT INTO auth.users (id, email, role)
VALUES (
  '00000000-0000-0000-0000-000000000001',
  '${ADMIN_EMAIL}',
  'admin'
)
ON CONFLICT (id) DO UPDATE SET
  email = EXCLUDED.email,
  role = EXCLUDED.role;
```

#### Environment-Specific Seeds

```
seeds/
├── all/                         # Run in all environments
│   ├── 001_roles.sql
│   └── 002_config.sql
├── local/                       # Local development only
│   ├── test_users.sql
│   └── sample_products.sql
├── staging/                     # Staging only
│   └── demo_accounts.sql
└── prod/                        # Production only
    └── admin_user.sql
```

#### Idempotent Seeding

Seeds are safe to run multiple times:

```sql
-- Uses ON CONFLICT for upserts
INSERT INTO roles (name, permissions)
VALUES ('admin', '{"all": true}')
ON CONFLICT (name) DO UPDATE SET
  permissions = EXCLUDED.permissions;

-- Or checks existence
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM users WHERE email = 'admin@example.com') THEN
    INSERT INTO users (email, role) VALUES ('admin@example.com', 'admin');
  END IF;
END $$;
```

#### Seed Tracking

```sql
-- _nself_seeds table
CREATE TABLE _nself_seeds (
  name TEXT PRIMARY KEY,
  environment TEXT,
  applied_at TIMESTAMPTZ DEFAULT NOW(),
  checksum TEXT
);
```

---

### 3. Data Utilities (`nself data`)

#### Subcommands
```bash
# Export/Import
nself data export                # Export all data as JSON
nself data export users          # Export specific table
nself data export --format csv   # Export as CSV
nself data export --output ./dump

nself data import <file>         # Import from JSON/CSV
nself data import users.json     # Import to specific table

# Anonymization
nself data anonymize             # Anonymize PII in current DB
nself data anonymize --preview   # Preview changes
nself data anonymize --config anonymize.yaml

# Reset
nself data reset                 # Reset to clean state
nself data reset --keep-schema   # Keep structure, remove data
nself data reset --keep-seeds    # Keep seeded data
```

#### Data Anonymization

```yaml
# anonymize.yaml
rules:
  users:
    email:
      method: mask
      format: "user{id}@example.com"
    first_name:
      method: fake
      type: first_name
    last_name:
      method: fake
      type: last_name
    phone:
      method: hash
    address:
      method: fake
      type: address

  orders:
    shipping_address:
      method: fake
      type: address

  # Preserve certain columns
  transactions:
    amount:
      method: preserve  # Keep actual amounts
    created_at:
      method: preserve

# Skip anonymization for some tables
skip:
  - _nself_migrations
  - _nself_seeds
  - app_config
```

#### Anonymization Methods

| Method | Description |
|--------|-------------|
| `fake` | Replace with realistic fake data |
| `mask` | Mask with pattern (e.g., `user{id}@...`) |
| `hash` | One-way hash (consistent) |
| `null` | Set to NULL |
| `preserve` | Keep original value |
| `truncate` | Clear entire table |

---

### 4. Direct VPS Support Enhancements

#### IP-Based Deployment

```bash
# Deploy to VPS by IP address (no domain needed)
nself deploy staging --host 45.33.123.456

# Configuration
nself env create staging
# Prompts:
# > Host (domain or IP): 45.33.123.456
# > SSH User: root
# > SSH Port [22]: 22
# > SSH Key [~/.ssh/id_ed25519]:
```

#### Automatic hosts file (local development)

```bash
# For local testing with IP-based staging
nself hosts add staging 45.33.123.456

# Adds to /etc/hosts (with sudo):
# 45.33.123.456 staging.myapp.local
# 45.33.123.456 api.staging.myapp.local
```

#### Self-Signed SSL for IP Access

```bash
# Generate self-signed cert for IP
nself ssl generate --ip 45.33.123.456

# Creates cert with IP in SAN
# Warns about browser security warnings
```

---

## Implementation Files

### New CLI Commands
```
src/cli/seed.sh              # Seeding command
src/cli/mock.sh              # Mock data command
src/cli/data.sh              # Data utilities
```

### New Library Files
```
src/lib/mock/
├── generate.sh              # Mock generation engine
├── schema.sh                # Schema analysis
├── types.sh                 # Type-to-generator mapping
├── faker.sh                 # Fake data generation
├── relationships.sh         # Foreign key handling
└── config.sh                # Mock configuration

src/lib/seed/
├── run.sh                   # Seed execution
├── create.sh                # Seed file creation
├── track.sh                 # Seed tracking
└── environment.sh           # Environment filtering

src/lib/data/
├── export.sh                # Data export
├── import.sh                # Data import
├── anonymize.sh             # Anonymization engine
└── reset.sh                 # Data reset

src/lib/vps/
├── ip-deploy.sh             # IP-based deployment
├── hosts.sh                 # Hosts file management
└── ip-ssl.sh                # IP SSL certificates
```

### Templates
```
src/templates/seeds/
├── admin_user.sql.template
├── roles.sql.template
└── app_config.sql.template

src/templates/mock/
└── mock.yaml.template
```

---

## Environment Variable Additions

```bash
# Mock Data
MOCK_ENABLED=true                # Enable mock data (auto-false in prod)
MOCK_LOCALE=en_US
MOCK_SEED=                       # For reproducible data
MOCK_DEFAULT_COUNT=100

# Seeding
SEED_PATH=./seeds
SEED_ADMIN_EMAIL=admin@example.com
SEED_ADMIN_PASSWORD=             # Hashed on seed

# Data
DATA_EXPORT_PATH=./exports
DATA_ANONYMIZE_CONFIG=./anonymize.yaml

# VPS
VPS_HOST=                        # IP or hostname
VPS_SSH_USER=root
VPS_SSH_PORT=22
VPS_SSH_KEY=~/.ssh/id_ed25519
```

---

## Testing Requirements

### Unit Tests
- Schema parsing
- Type detection
- Foreign key resolution
- Anonymization rules

### Integration Tests
- Full mock generation cycle
- Seed execution with tracking
- Export/import round-trip
- Cross-environment anonymization

### Manual Testing
- Mock data with 50+ table schema
- Seeding with circular references
- Large dataset anonymization

---

## Documentation Required

```
docs/commands/SEED.md
docs/commands/MOCK.md
docs/commands/DATA.md
docs/guides/mock-data.md
docs/guides/seeding.md
docs/guides/data-anonymization.md
docs/guides/vps-deployment.md
```

---

## Dependencies

- No external dependencies for mock generation (built-in)
- Optional: Faker library integration for advanced generation

---

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Mock data in production | Hard block, ENV check |
| Circular foreign keys | Detect and warn, manual ordering |
| Anonymization misses PII | Audit mode, pattern detection |
| Large dataset performance | Batch processing, progress bar |
| IP-based security concerns | Clear warnings, self-signed cert notices |

---

## Success Criteria

1. ✓ `nself mock generate` creates realistic data
2. ✓ Mock data respects all foreign keys
3. ✓ Seeds are idempotent (safe to re-run)
4. ✓ Environment detection is automatic
5. ✓ Anonymization catches common PII patterns
6. ✓ VPS IP deployment works without domain
7. ✓ Self-signed SSL works for IP addresses

---

*Last Updated: January 22, 2026*
