# v0.4.3 Planning - Deployment Pipeline

**Target**: Q1 2026
**Focus**: Complete local → staging → production workflow

---

## Overview

Everything needed to deploy from development to production seamlessly. This is the foundational release that enables the full deployment lifecycle.

---

## New Commands

| Command | Purpose |
|---------|---------|
| `nself env` | Environment management (local/staging/prod) |
| `nself deploy` | Deploy to any environment |
| `nself prod` | Production configuration & hardening |
| `nself staging` | Staging environment setup |

---

## Detailed Feature Specifications

### 1. Environment Management (`nself env`)

#### Subcommands
```bash
nself env create <name>      # Create new environment (staging, prod, custom)
nself env list               # List all environments with status
nself env switch <name>      # Switch active environment
nself env delete <name>      # Remove environment (with confirmation)
nself env status             # Show current environment details
nself env diff <a> <b>       # Compare two environments
nself env export <name>      # Export environment config
nself env import <file>      # Import environment config
```

#### Environment Types
- **local** (default): Development environment, localhost
- **staging**: Pre-production testing environment
- **prod/production**: Live production environment
- **custom**: User-defined environments (e.g., qa, demo, client-name)

#### Environment Files Structure
```
project/
├── .env                    # Active environment (symlink or copy)
├── .env.local              # Local development
├── .env.staging            # Staging environment
├── .env.prod               # Production environment
└── environments/
    ├── local/
    │   ├── .env
    │   └── docker-compose.override.yml
    ├── staging/
    │   ├── .env
    │   ├── server.json     # Server connection details
    │   └── docker-compose.override.yml
    └── prod/
        ├── .env
        ├── server.json
        └── docker-compose.override.yml
```

#### Environment Inheritance
- Production inherits from staging
- Staging inherits from local
- Only override what changes
- Sensible defaults at each level

---

### 2. Deployment (`nself deploy`)

#### Subcommands
```bash
nself deploy <env>           # Deploy to environment
nself deploy staging         # Deploy to staging
nself deploy prod            # Deploy to production
nself deploy prod --dry-run  # Preview deployment changes
nself deploy --rollback      # Rollback to previous deployment
nself deploy --status        # Show deployment status
nself deploy --logs          # Show deployment logs
```

#### Deployment Methods

##### SSH-Based Deployment (Primary)
```bash
# Detects SSH keys automatically
nself deploy staging

# Or specify credentials
nself deploy staging --user admin --host 192.168.1.100
nself deploy prod --key ~/.ssh/prod_key --host prod.example.com
```

##### Direct IP Support
```bash
# Works without domain - uses IP directly
nself deploy staging --host 45.33.123.456
nself deploy prod --host 192.168.1.50 --port 22
```

#### CRITICAL: Access Control Considerations

**Problem**: Not everyone on a team has access to staging/production servers.

**Solutions Implemented**:

1. **SSH Key Detection**
   ```bash
   # Automatically detect available SSH keys
   detect_ssh_keys() {
     local keys=()
     for key in ~/.ssh/id_rsa ~/.ssh/id_ed25519 ~/.ssh/id_ecdsa; do
       [[ -f "$key" ]] && keys+=("$key")
     done
     # Check for keys matching server hostname
     for key in ~/.ssh/*; do
       [[ -f "$key" && ! "$key" =~ \.pub$ ]] && keys+=("$key")
     done
     echo "${keys[@]}"
   }
   ```

2. **Credential Storage Options**
   - `environments/<env>/server.json` - Server connection details
   - Environment variables: `STAGING_HOST`, `STAGING_USER`, `STAGING_KEY`
   - Interactive prompt (never stored)
   - System keychain integration (macOS Keychain, Linux Secret Service)

3. **Access Levels**
   ```bash
   # In environments/staging/server.json
   {
     "host": "staging.example.com",
     "port": 22,
     "user": "deploy",
     "auth": "ssh-key",           # or "password", "key-file"
     "key_path": "~/.ssh/staging_key",
     "restricted_users": ["dev1", "dev2"],  # Can view, not deploy
     "deploy_users": ["lead", "admin"]       # Can deploy
   }
   ```

4. **Permission Checks**
   ```bash
   nself deploy staging --check-access
   # Output: You have deploy access to staging (SSH key: ~/.ssh/id_ed25519)

   nself deploy prod --check-access
   # Output: You do NOT have deploy access to prod (no SSH key found)
   ```

5. **Credential Input Methods**
   - SSH key path
   - SSH key from agent
   - Username/password (interactive, not stored)
   - Environment variables
   - CI/CD secrets injection

#### Deployment Process
1. Pre-deployment checks (health, disk space, permissions)
2. Create backup of current state
3. Pull latest code/images
4. Run migrations (if any)
5. Rolling restart of services
6. Health check verification
7. Rollback if health checks fail

#### Zero-Downtime Deployment
- Rolling updates (one container at a time)
- Health check gates between updates
- Automatic rollback on failure
- Connection draining

---

### 3. Production Hardening (`nself prod`)

#### Subcommands
```bash
nself prod init              # Interactive production setup wizard
nself prod check             # Security audit / checklist
nself prod secrets           # Secrets management
nself prod ssl               # SSL/TLS configuration
nself prod firewall          # Firewall configuration helpers
nself prod harden            # Apply security hardening
```

#### Security Checklist (`nself prod check`)
```
Production Security Checklist
─────────────────────────────
✓ Strong database password (32+ chars)
✓ Unique Hasura admin secret
✓ SSL/TLS certificates valid
✗ Debug mode disabled
✗ Error details hidden from users
✓ Rate limiting configured
✗ CORS properly configured
✓ Firewall rules in place
✓ Backup schedule configured
✗ Monitoring alerts configured

Score: 7/10 - Review items marked ✗
```

#### Secrets Management
```bash
nself prod secrets list              # List all secrets (masked)
nself prod secrets set KEY=value     # Set a secret
nself prod secrets generate          # Generate secure secrets
nself prod secrets rotate            # Rotate all secrets
nself prod secrets export --encrypted # Export for backup
```

#### SSL/TLS with Let's Encrypt
```bash
nself prod ssl init                  # Setup Let's Encrypt
nself prod ssl renew                 # Force renewal
nself prod ssl status                # Certificate status
```

---

### 4. Staging Environment (`nself staging`)

#### Subcommands
```bash
nself staging init           # Initialize staging environment
nself staging sync           # Sync from production (anonymized)
nself staging reset          # Reset to clean state
nself staging url            # Show staging URLs
```

---

## Implementation Files

### New CLI Commands
```
src/cli/env.sh               # Environment management
src/cli/deploy.sh            # Deployment command
src/cli/prod.sh              # Production configuration
src/cli/staging.sh           # Staging management
```

### New Library Files
```
src/lib/deploy/
├── ssh.sh                   # SSH connection handling
├── rsync.sh                 # File synchronization
├── rollback.sh              # Rollback functionality
├── health-check.sh          # Deployment health checks
├── zero-downtime.sh         # Rolling deployment logic
└── credentials.sh           # Credential detection/management

src/lib/env/
├── create.sh                # Environment creation
├── switch.sh                # Environment switching
├── diff.sh                  # Environment comparison
├── inherit.sh               # Config inheritance logic
└── validate.sh              # Environment validation

src/lib/security/
├── checklist.sh             # Security audit
├── secrets.sh               # Secrets management
├── ssl-letsencrypt.sh       # Let's Encrypt integration
└── firewall.sh              # Firewall helpers
```

### Configuration Templates
```
src/templates/environments/
├── local/
│   └── .env.template
├── staging/
│   ├── .env.template
│   └── server.json.template
└── prod/
    ├── .env.template
    └── server.json.template
```

---

## Environment Variable Additions

```bash
# Deployment
DEPLOY_METHOD=ssh                    # ssh, docker-context, kubernetes
DEPLOY_HEALTH_TIMEOUT=120            # Seconds to wait for health
DEPLOY_ROLLBACK_ON_FAILURE=true      # Auto-rollback if unhealthy

# Staging
STAGING_HOST=staging.example.com
STAGING_USER=deploy
STAGING_PORT=22
STAGING_KEY=~/.ssh/staging_key

# Production
PROD_HOST=prod.example.com
PROD_USER=deploy
PROD_PORT=22
PROD_KEY=~/.ssh/prod_key

# SSL
SSL_PROVIDER=letsencrypt             # letsencrypt, manual, self-signed
SSL_EMAIL=admin@example.com
SSL_DOMAINS=example.com,*.example.com

# Security
SECURITY_HARDENING=auto              # auto, strict, relaxed
```

---

## Testing Requirements

### Unit Tests
- Environment creation/switching
- Config inheritance logic
- Credential detection
- Security checklist validation

### Integration Tests
- Full deployment to local Docker
- SSH connection (mock server)
- Rollback scenarios
- Zero-downtime verification

### Manual Testing
- Deploy to real staging server
- Deploy to real production server
- Verify all access control scenarios

---

## Documentation Required

```
docs/commands/ENV.md
docs/commands/DEPLOY.md
docs/commands/PROD.md
docs/commands/STAGING.md
docs/guides/deployment-pipeline.md
docs/guides/production-security.md
docs/guides/multi-environment.md
```

---

## Dependencies

- OpenSSH client (ssh, scp, ssh-keygen)
- rsync (for file sync)
- curl (for health checks)
- certbot (optional, for Let's Encrypt)

---

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| SSH key not found | Clear error message, credential prompt |
| Deployment fails mid-way | Automatic rollback with backup |
| Wrong environment deployed to | Confirmation prompts, `--dry-run` |
| Secrets exposed in logs | Mask all sensitive values |
| Permission denied on server | Pre-check access before deploying |

---

## Success Criteria

1. ✓ `nself deploy staging` works with SSH key auto-detection
2. ✓ `nself deploy prod --dry-run` shows accurate preview
3. ✓ Rollback works automatically on health check failure
4. ✓ Environment switching is seamless
5. ✓ Security checklist catches common issues
6. ✓ Works with direct IP addresses (no domain required)
7. ✓ Access control properly restricts unauthorized users

---

## Notes for Future Development

- v0.4.5 will add VPS IP address deployment enhancements
- v0.4.7 will add cloud provider deployment (extends this foundation)
- v0.4.8 will add Kubernetes deployment (extends this foundation)

---

*Last Updated: January 22, 2026*
