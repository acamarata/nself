# Configuration Guide

Comprehensive guide to configuring nself for development, staging, and production environments.

## üìö Table of Contents

- [Overview](#overview)
- [Environment Files](#environment-files)
- [Core Configuration](#core-configuration)
- [Service Configuration](#service-configuration)
- [Advanced Configuration](#advanced-configuration)
- [Environment Management](#environment-management)
- [Security Configuration](#security-configuration)
- [Performance Tuning](#performance-tuning)
- [Troubleshooting](#troubleshooting)

---

## Overview

nself uses a cascading environment file system for configuration, allowing flexible setup across different environments while maintaining simplicity.

### Configuration Philosophy

1. **Smart Defaults**: Works out-of-the-box with intelligent defaults
2. **Override Hierarchy**: Later files override earlier ones
3. **Single File Simplicity**: Can work with just `.env` if desired
4. **Environment Specific**: Automatic environment-based loading
5. **Security First**: Sensitive data separated in `.env.secrets`

## Environment Files

### File Loading Order

Files are loaded in this specific cascade (later overrides earlier):

```bash
1. .env.dev        # Development defaults (always loaded)
2. .env.staging    # Staging overrides (if ENV=staging)
3. .env.prod       # Production config (if ENV=prod)
4. .env.secrets    # Sensitive data (if ENV=prod)
5. .env            # Local overrides (HIGHEST PRIORITY)
```

### File Purposes

| File | Purpose | Committed to Git | When Loaded |
|------|---------|-----------------|-------------|
| `.env.dev` | Team development defaults | ‚úÖ Yes | Always |
| `.env.staging` | Staging environment | ‚úÖ Yes | ENV=staging |
| `.env.prod` | Production settings | ‚ö†Ô∏è Template only | ENV=prod |
| `.env.secrets` | Passwords, API keys | ‚ùå Never | ENV=prod |
| `.env` | Local overrides | ‚ùå No | Always (last) |

### Creating Environment Files

```bash
# Initialize with smart defaults
nself init

# Generate production config
nself prod

# Validate configuration
nself validate
```

## Core Configuration

### Essential Variables

```bash
# Project Settings
PROJECT_NAME=my-app              # Docker project name
BASE_DOMAIN=local.nself.org      # Base domain for services
ENV=dev                          # Environment: dev|staging|prod

# Core Services
POSTGRES_ENABLED=true            # PostgreSQL database
HASURA_ENABLED=true              # GraphQL API
AUTH_ENABLED=true                # Authentication service
STORAGE_ENABLED=true             # S3-compatible storage
NGINX_ENABLED=true               # Reverse proxy

# Ports
POSTGRES_PORT=5432               # PostgreSQL port
HASURA_PORT=8080                 # Hasura GraphQL port
AUTH_PORT=4000                   # Auth service port
STORAGE_PORT=4002                # Storage service port
NGINX_HTTP_PORT=80               # HTTP port
NGINX_HTTPS_PORT=443             # HTTPS port
```

### Database Configuration

```bash
# PostgreSQL Settings
POSTGRES_USER=postgres           # Database user
POSTGRES_PASSWORD=<auto>         # Auto-generated if empty
POSTGRES_DB=nself                # Default database
POSTGRES_MAX_CONNECTIONS=100     # Maximum connections
POSTGRES_SHARED_BUFFERS=256MB    # Shared memory
POSTGRES_WORK_MEM=4MB            # Working memory
POSTGRES_MAINTENANCE_WORK_MEM=64MB

# PostgreSQL Extensions (60+ available)
POSTGRES_EXTENSIONS=postgis,pg_trgm,uuid-ossp,hstore

# External Database (optional)
POSTGRES_EXTERNAL=false          # Use external database
POSTGRES_HOST=db.example.com     # External host
POSTGRES_SSL_MODE=require        # SSL mode
```

### Authentication Configuration

```bash
# Auth Service
AUTH_ENABLED=true
AUTH_PORT=4000
AUTH_CLIENT_URL=http://localhost:3000
AUTH_SERVER_URL=http://localhost:4000

# JWT Settings
AUTH_JWT_SECRET=<auto-generated>
AUTH_JWT_EXPIRES_IN=15m
AUTH_REFRESH_TOKEN_EXPIRES_IN=30d

# OAuth Providers (optional)
AUTH_GITHUB_CLIENT_ID=
AUTH_GITHUB_CLIENT_SECRET=
AUTH_GOOGLE_CLIENT_ID=
AUTH_GOOGLE_CLIENT_SECRET=

# Email Verification
AUTH_EMAIL_VERIFICATION=true
AUTH_EMAIL_VERIFICATION_REQUIRED=false

# Password Policy
AUTH_PASSWORD_MIN_LENGTH=8
AUTH_PASSWORD_REQUIRE_UPPERCASE=true
AUTH_PASSWORD_REQUIRE_NUMBER=true
```

### Storage Configuration

```bash
# MinIO S3-Compatible Storage
STORAGE_ENABLED=true
STORAGE_PORT=4002
MINIO_PORT=9000
MINIO_CONSOLE_PORT=9001

# Storage Credentials
MINIO_ROOT_USER=minioadmin
MINIO_ROOT_PASSWORD=<auto-generated>
STORAGE_ACCESS_KEY=<auto-generated>
STORAGE_SECRET_KEY=<auto-generated>

# Storage Settings
STORAGE_DEFAULT_BUCKET=default
STORAGE_PUBLIC_BUCKET=public
STORAGE_MAX_FILE_SIZE=50MB
STORAGE_ALLOWED_MIME_TYPES=image/*,application/pdf

# S3 Configuration (for external S3)
STORAGE_S3_ENDPOINT=s3.amazonaws.com
STORAGE_S3_REGION=us-east-1
STORAGE_S3_BUCKET=my-bucket
```

## Service Configuration

### GraphQL Engine (Hasura)

```bash
# Hasura Configuration
HASURA_ENABLED=true
HASURA_PORT=8080
HASURA_GRAPHQL_ADMIN_SECRET=<auto-generated>
HASURA_GRAPHQL_DATABASE_URL=postgres://...

# Hasura Features
HASURA_GRAPHQL_ENABLE_CONSOLE=true
HASURA_GRAPHQL_DEV_MODE=true
HASURA_GRAPHQL_ENABLE_TELEMETRY=false
HASURA_GRAPHQL_ENABLE_REMOTE_SCHEMA_PERMISSIONS=true

# Performance
HASURA_GRAPHQL_EVENTS_HTTP_POOL_SIZE=100
HASURA_GRAPHQL_EVENTS_FETCH_BATCH_SIZE=100
HASURA_GRAPHQL_CONNECTION_POOL_SIZE=50
```

### Email Service

```bash
# Email Configuration
EMAIL_ENABLED=true
EMAIL_PROVIDER=mailpit          # Dev: mailpit | Prod: smtp,sendgrid,etc

# Mailpit (Development)
MAILPIT_PORT=1025               # SMTP port
MAILPIT_UI_PORT=8025            # Web UI port

# SMTP (Production)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=true
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-app-password
SMTP_FROM=noreply@myapp.com

# Email Providers (choose one)
SENDGRID_API_KEY=
MAILGUN_API_KEY=
MAILGUN_DOMAIN=
AWS_SES_REGION=
AWS_SES_ACCESS_KEY=
AWS_SES_SECRET_KEY=
```

### Admin UI

```bash
# Admin Dashboard
NSELF_ADMIN_ENABLED=true
NSELF_ADMIN_PORT=3100
NSELF_ADMIN_AUTH_PROVIDER=basic

# Admin Credentials
ADMIN_USERNAME=admin
ADMIN_PASSWORD_HASH=<bcrypt-hash>
ADMIN_SECRET_KEY=<auto-generated>

# Admin Features
NSELF_ADMIN_ENABLE_LOGS=true
NSELF_ADMIN_ENABLE_EXEC=true
NSELF_ADMIN_ENABLE_BACKUPS=true
```

### Optional Services

```bash
# Redis Cache
REDIS_ENABLED=false
REDIS_PORT=6379
REDIS_PASSWORD=<auto-generated>
REDIS_MAXMEMORY=256mb
REDIS_MAXMEMORY_POLICY=allkeys-lru

# Monitoring Stack
PROMETHEUS_ENABLED=false
PROMETHEUS_PORT=9090
GRAFANA_ENABLED=false
GRAFANA_PORT=3000
LOKI_ENABLED=false
LOKI_PORT=3100

# Message Queue
RABBITMQ_ENABLED=false
RABBITMQ_PORT=5672
RABBITMQ_MANAGEMENT_PORT=15672

# Workflow Engine
TEMPORAL_ENABLED=false
TEMPORAL_PORT=7233
TEMPORAL_UI_PORT=8088
```

## Advanced Configuration

### Microservices

```bash
# Enable Microservices
SERVICES_ENABLED=true

# Node.js Services
NODEJS_SERVICES=api,workers,websocket
NODEJS_VERSION=20-alpine
NODEJS_PACKAGE_MANAGER=npm

# Python Services
PYTHON_SERVICES=ml,data-pipeline
PYTHON_VERSION=3.11-slim
PYTHON_PACKAGE_MANAGER=pip

# Go Services
GOLANG_SERVICES=auth-proxy,metrics
GOLANG_VERSION=1.21-alpine

# Custom Services
CUSTOM_SERVICES=rust-api,java-worker
```

### SSL/TLS Configuration

```bash
# SSL Settings
SSL_ENABLED=true
SSL_PROVIDER=mkcert            # mkcert|letsencrypt|custom

# Let's Encrypt (Production)
LETSENCRYPT_EMAIL=admin@myapp.com
LETSENCRYPT_STAGING=false

# Custom Certificates
SSL_CERT_PATH=/ssl/cert.pem
SSL_KEY_PATH=/ssl/key.pem
SSL_CA_PATH=/ssl/ca.pem

# HTTPS Redirect
NGINX_FORCE_HTTPS=true
NGINX_HSTS_ENABLED=true
```

### Networking

```bash
# Docker Network
DOCKER_NETWORK=nself_network
DOCKER_NETWORK_DRIVER=bridge
DOCKER_NETWORK_SUBNET=172.20.0.0/16

# Service Discovery
SERVICE_DISCOVERY_ENABLED=true
CONSUL_ENABLED=false
CONSUL_PORT=8500

# Load Balancing
LOAD_BALANCER_ENABLED=false
TRAEFIK_ENABLED=false
TRAEFIK_PORT=8080
```

### Resource Limits

```bash
# Container Resources
POSTGRES_MEMORY_LIMIT=2G
POSTGRES_CPU_LIMIT=2.0

HASURA_MEMORY_LIMIT=1G
HASURA_CPU_LIMIT=1.0

AUTH_MEMORY_LIMIT=512M
AUTH_CPU_LIMIT=0.5

STORAGE_MEMORY_LIMIT=512M
STORAGE_CPU_LIMIT=0.5

# Swap Limits
DOCKER_MEMORY_SWAP=-1          # Unlimited swap
```

## Environment Management

### Development Environment

```bash
# .env.dev
ENV=dev
BASE_DOMAIN=local.nself.org
HASURA_GRAPHQL_DEV_MODE=true
HASURA_GRAPHQL_ENABLE_CONSOLE=true
EMAIL_PROVIDER=mailpit
LOG_LEVEL=debug
```

### Staging Environment

```bash
# .env.staging
ENV=staging
BASE_DOMAIN=staging.myapp.com
SSL_ENABLED=true
SSL_PROVIDER=letsencrypt
HASURA_GRAPHQL_DEV_MODE=false
EMAIL_PROVIDER=smtp
LOG_LEVEL=info
```

### Production Environment

```bash
# .env.prod
ENV=prod
BASE_DOMAIN=api.myapp.com
SSL_ENABLED=true
SSL_PROVIDER=letsencrypt
HASURA_GRAPHQL_DEV_MODE=false
HASURA_GRAPHQL_ENABLE_CONSOLE=false
EMAIL_PROVIDER=sendgrid
LOG_LEVEL=warning

# Performance
POSTGRES_MAX_CONNECTIONS=200
HASURA_GRAPHQL_CONNECTION_POOL_SIZE=100
REDIS_ENABLED=true

# Security
NGINX_RATE_LIMIT=100r/s
NGINX_HSTS_ENABLED=true
AUTH_SESSION_SECURE=true
```

## Security Configuration

### Secrets Management

```bash
# .env.secrets (never commit!)
POSTGRES_PASSWORD=<strong-password>
HASURA_GRAPHQL_ADMIN_SECRET=<strong-secret>
AUTH_JWT_SECRET=<strong-jwt-secret>
MINIO_ROOT_PASSWORD=<strong-password>
ADMIN_PASSWORD_HASH=<bcrypt-hash>

# API Keys
SENDGRID_API_KEY=<api-key>
STRIPE_SECRET_KEY=<secret-key>
AWS_SECRET_ACCESS_KEY=<secret-key>
```

### Security Headers

```bash
# Nginx Security Headers
NGINX_CSP_ENABLED=true
NGINX_CSP_POLICY="default-src 'self'"
NGINX_X_FRAME_OPTIONS=DENY
NGINX_X_CONTENT_TYPE_OPTIONS=nosniff
NGINX_X_XSS_PROTECTION="1; mode=block"
```

### Firewall Rules

```bash
# IP Whitelisting
NGINX_IP_WHITELIST=10.0.0.0/8,192.168.0.0/16
ADMIN_IP_WHITELIST=10.0.0.1,10.0.0.2

# Rate Limiting
NGINX_RATE_LIMIT_ENABLED=true
NGINX_RATE_LIMIT=10r/s
NGINX_RATE_LIMIT_BURST=20
```

## Performance Tuning

### Database Optimization

```bash
# PostgreSQL Tuning
POSTGRES_SHARED_BUFFERS=1GB     # 25% of RAM
POSTGRES_EFFECTIVE_CACHE_SIZE=3GB # 75% of RAM
POSTGRES_WORK_MEM=10MB
POSTGRES_MAINTENANCE_WORK_MEM=256MB
POSTGRES_MAX_WAL_SIZE=2GB
POSTGRES_CHECKPOINT_COMPLETION_TARGET=0.9
```

### Caching Strategy

```bash
# Redis Cache
REDIS_ENABLED=true
REDIS_MAXMEMORY=1gb
REDIS_MAXMEMORY_POLICY=allkeys-lru

# Nginx Cache
NGINX_CACHE_ENABLED=true
NGINX_CACHE_SIZE=1g
NGINX_CACHE_MAX_AGE=1d
```

### Connection Pooling

```bash
# PgBouncer (optional)
PGBOUNCER_ENABLED=true
PGBOUNCER_PORT=6432
PGBOUNCER_POOL_MODE=transaction
PGBOUNCER_MAX_CLIENT_CONN=1000
PGBOUNCER_DEFAULT_POOL_SIZE=25
```

## Troubleshooting

### Configuration Validation

```bash
# Validate all configuration
nself validate

# Check specific service config
nself config postgres
nself config hasura

# Show computed configuration
nself config --computed
```

### Common Issues

#### Missing Environment Variables
```bash
# Check for required variables
nself doctor

# Auto-fix missing variables
AUTO_FIX=true nself build
```

#### Port Conflicts
```bash
# Auto-reassign ports
AUTO_FIX=true nself build

# Or manually change
HASURA_PORT=8081
```

#### Permission Issues
```bash
# Fix file permissions
chmod 600 .env.secrets
chmod 644 .env.dev

# Fix Docker permissions
sudo usermod -aG docker $USER
```

### Debug Mode

```bash
# Enable debug output
DEBUG=true nself build

# Verbose logging
LOG_LEVEL=debug
DOCKER_BUILDKIT=0
```

## Configuration Templates

### Minimal Configuration

```bash
# .env (minimal)
PROJECT_NAME=my-app
```

### Standard Web App

```bash
# .env (web app)
PROJECT_NAME=my-app
BASE_DOMAIN=local.myapp.com

POSTGRES_ENABLED=true
HASURA_ENABLED=true
AUTH_ENABLED=true
STORAGE_ENABLED=true
REDIS_ENABLED=true

SERVICES_ENABLED=true
NODEJS_SERVICES=api,workers
```

### Microservices Architecture

```bash
# .env (microservices)
PROJECT_NAME=my-platform
BASE_DOMAIN=platform.local

# Core services
POSTGRES_ENABLED=true
REDIS_ENABLED=true
RABBITMQ_ENABLED=true

# Microservices
SERVICES_ENABLED=true
NODEJS_SERVICES=gateway,users,orders
PYTHON_SERVICES=analytics,ml
GOLANG_SERVICES=payments,notifications

# Monitoring
PROMETHEUS_ENABLED=true
GRAFANA_ENABLED=true
```

## Best Practices

1. **Never commit secrets** - Use `.gitignore` for `.env` and `.env.secrets`
2. **Use strong passwords** - Let auto-generation handle it
3. **Environment-specific configs** - Separate dev/staging/prod
4. **Regular backups** - Configure automated backups
5. **Monitor resources** - Set appropriate limits
6. **Update regularly** - Keep services up-to-date
7. **Document changes** - Comment custom configurations

---

**Next Steps:**
- [Quick Start](Quick-Start) - Get running quickly
- [Environment Variables Reference](Environment-Variables) - Complete variable list
- [Production Deployment](Deployment) - Deploy to production
- [Security Guide](Security) - Harden your deployment